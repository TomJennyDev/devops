# ========================================
# PROMETHEUS STACK - STAGING ENVIRONMENT
# ========================================
# Official Chart: kube-prometheus-stack v65.2.0
# Source: https://github.com/prometheus-community/helm-charts/tree/main/charts/kube-prometheus-stack
# Full values reference: See default-values-reference.yaml (5413 lines)
# Documentation: https://prometheus.io/docs/

# ========================================
# PROMETHEUS SERVER
# ========================================
prometheus:
  prometheusSpec:
    # Retention & Storage
    retention: 15d  # Staging: 15 days retention
    retentionSize: "20GB"
    
    # Resources - Staging: Medium resources
    resources:
      requests:
        cpu: 500m
        memory: 2Gi
      limits:
        cpu: 1000m
        memory: 4Gi
    
    # Storage
    storageSpec:
      volumeClaimTemplate:
        spec:
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 50Gi  # Staging: 50GB storage
          storageClassName: gp3
    
    # Scrape interval
    scrapeInterval: 30s
    evaluationInterval: 30s
    
    # Service Monitor selectors
    serviceMonitorSelectorNilUsesHelmValues: false
    podMonitorSelectorNilUsesHelmValues: false
    ruleSelectorNilUsesHelmValues: false
    
    # Replicas - HA
    replicas: 2  # Staging: 2 replicas for HA

# ========================================
# GRAFANA
# ========================================
grafana:
  enabled: true
  
  # Admin credentials
  adminPassword: "changeme-staging"  # Use Sealed Secrets in real env
  
  # Resources - Staging: Medium resources
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi
  
  # Persistence
  persistence:
    enabled: true
    size: 10Gi  # Staging: 10GB
    storageClassName: gp3
  
  # Service type
  service:
    type: ClusterIP
    port: 80
  
  # Ingress with ALB (optional)
  ingress:
    enabled: false  # Set true if using ALB Controller
    ingressClassName: alb
    annotations:
      alb.ingress.kubernetes.io/scheme: internal
      alb.ingress.kubernetes.io/target-type: ip
    hosts:
      - grafana-staging.internal.example.com
  
  # Default dashboards
  defaultDashboardsEnabled: true
  defaultDashboardsTimezone: Asia/Singapore
  
  # Replicas
  replicas: 2  # Staging: 2 replicas for HA
  
  # Grafana config
  grafana.ini:
    server:
      root_url: "https://grafana-staging.internal.example.com"
    analytics:
      check_for_updates: false
    security:
      allow_embedding: true

# ========================================
# ALERTMANAGER
# ========================================
alertmanager:
  enabled: true
  
  alertmanagerSpec:
    # Resources - Staging: Medium
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 200m
        memory: 512Mi
    
    # Storage
    storage:
      volumeClaimTemplate:
        spec:
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 10Gi
          storageClassName: gp3
    
    replicas: 2  # Staging: 2 replicas for HA
  
  # Alert configuration
  config:
    global:
      resolve_timeout: 5m
      slack_api_url: ""  # Add Slack webhook for alerts
    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 10s
      group_interval: 10s
      repeat_interval: 12h
      receiver: 'slack-notifications'
      routes:
        - match:
            severity: critical
          receiver: 'slack-critical'
    receivers:
      - name: 'slack-notifications'
        slack_configs:
          - channel: '#staging-alerts'
            title: 'Prometheus Alert - Staging'
      - name: 'slack-critical'
        slack_configs:
          - channel: '#staging-critical'
            title: 'CRITICAL - Staging'

# ========================================
# NODE EXPORTER
# ========================================
nodeExporter:
  enabled: true
  
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

# ========================================
# KUBE STATE METRICS
# ========================================
kubeStateMetrics:
  enabled: true
  
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 200m
      memory: 512Mi

# ========================================
# PROMETHEUS OPERATOR
# ========================================
prometheusOperator:
  enabled: true
  
  resources:
    requests:
      cpu: 200m
      memory: 256Mi
    limits:
      cpu: 400m
      memory: 512Mi
  
  admissionWebhooks:
    enabled: true
    patch:
      enabled: true

# ========================================
# DEFAULT SERVICE MONITORS
# ========================================
defaultRules:
  create: true
  rules:
    alertmanager: true
    etcd: false
    configReloaders: true
    general: true
    k8s: true
    kubeApiserverAvailability: true
    kubeApiserverSlos: true
    kubelet: true
    kubeProxy: true
    kubePrometheusGeneral: true
    kubePrometheusNodeRecording: true
    kubernetesApps: true
    kubernetesResources: true
    kubernetesStorage: true
    kubernetesSystem: true
    kubeScheduler: false
    kubeStateMetrics: true
    network: true
    node: true
    nodeExporterAlerting: true
    nodeExporterRecording: true
    prometheus: true
    prometheusOperator: true
