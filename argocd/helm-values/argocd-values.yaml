## ============================================
## ARGOCD HELM VALUES - GitHub Workflow Integration
## ============================================
## Optimized for GitHub Actions CI/CD workflow
## Based on: https://github.com/argoproj/argo-helm/tree/main/charts/argo-cd
## Last Updated: 2025-12-05

# -- Provide a name in place of `argocd`
nameOverride: argocd

## ============================================
## GLOBAL CONFIGURATION
## ============================================
global:
  # -- Default domain used by all components
  # üìù BI·∫æN ƒê·ªòNG: Thay ƒë·ªïi th√†nh domain c·ªßa b·∫°n
  # Hi·ªán t·∫°i: argocd.do2506.click
  # V√≠ d·ª•: argocd.yourdomain.com
  # Ph·∫£i kh·ªõp v·ªõi certificate ARN v√† ingress host b√™n d∆∞·ªõi
  domain: argocd.do2506.click  # ‚ö†Ô∏è THAY ƒê·ªîI domain c·ªßa b·∫°n

  # Default image used by all components
  image:
    repository: quay.io/argoproj/argocd
    tag: ""  # Uses chart appVersion
    imagePullPolicy: IfNotPresent

  # Default logging options
  logging:
    format: json  # Better for log aggregation
    level: info

  # -- Toggle and define pod-level security context
  securityContext:
    runAsNonRoot: true
    runAsUser: 999
    fsGroup: 999

## ============================================
## ARGO CD CONFIGS
## ============================================
configs:
  # -- Repository credentials configuration
  repositories:
    # Single DevOps repository containing all manifests
    devops:
      # üìù BI·∫æN ƒê·ªòNG: Thay ƒë·ªïi n·∫øu d√πng repo kh√°c
      # Hi·ªán t·∫°i: Public repo (kh√¥ng c·∫ßn credentials)
      # N·∫øu private repo: C·∫ßn add credentials sau khi deploy ArgoCD
      # Command: argocd repo add <URL> --username <user> --password <token>
      url: https://github.com/TomJennyDev/devops.git
      type: git
      name: devops
      # For private repository, add credentials via ArgoCD UI or CLI:
      # argocd repo add https://github.com/TomJennyDev/devops.git \
      #   --username <github-username> --password <github-token>

  # General Argo CD configuration
  params:
    # ‚ö†Ô∏è CRITICAL: Enable for GitHub Actions gRPC-web support
    server.insecure: "true"  # Required for argocd CLI login --insecure
    server.enable.gzip: "true"
    
    # Timeout settings for application reconciliation
    timeout.reconciliation: "180s"
    timeout.hard.reconciliation: "0"
    
    # Application instance label
    application.instanceLabelKey: "argocd.argoproj.io/instance"

  # Argo CD configuration (ConfigMap)
  cm:
    # Repository refresh timeout
    timeout.reconciliation: "180s"
    
    # Enable status badge
    statusbadge.enabled: "true"
    
    # Resource exclusions
    resource.exclusions: |
      - apiGroups:
        - cilium.io
        kinds:
        - CiliumIdentity
        clusters:
        - "*"

  # RBAC configuration
  rbac:
    # Default role for new users
    policy.default: "role:readonly"
    
    # Enable API key generation scopes
    scopes: "[accounts:apiKey]"
    
    # -- Policy CSV for defining custom roles and permissions
    policy.csv: |
      # Admin role - full access
      p, role:admin, applications, *, */*, allow
      p, role:admin, clusters, *, *, allow
      p, role:admin, repositories, *, *, allow
      p, role:admin, projects, *, *, allow
      p, role:admin, accounts, *, *, allow
      p, role:admin, gpgkeys, *, *, allow
      p, role:admin, certificates, *, *, allow
      
      # ‚ö†Ô∏è CI/CD role - for GitHub Actions
      p, role:cicd, applications, get, */*, allow
      p, role:cicd, applications, sync, */*, allow
      p, role:cicd, applications, refresh, */*, allow
      p, role:cicd, applications, override, */*, allow
      p, role:cicd, applications, create, */*, allow
      p, role:cicd, applications, update, */*, allow
      p, role:cicd, repositories, get, *, allow
      p, role:cicd, repositories, list, *, allow
      p, role:cicd, repositories, update, *, allow
      
      # ReadOnly role
      p, role:readonly, applications, get, */*, allow
      p, role:readonly, repositories, get, *, allow
      p, role:readonly, clusters, get, *, allow
      p, role:readonly, projects, get, *, allow
      
      # Bind admin user to admin role
      g, admin, role:admin

  # Secret configuration
  secret:
    # Create the secret resource from the following data
    createSecret: true
    
    # -- Bcrypt hashed admin password
    # üìù BI·∫æN ƒê·ªòNG: ‚ö†Ô∏è B·∫ÆT BU·ªòC ƒë·ªïi cho production!
    # Hi·ªán t·∫°i: Comment out ƒë·ªÉ d√πng auto-generated password
    # Generate secure password:
    #   htpasswd -nbBC 10 "" YOUR_STRONG_PASSWORD | tr -d ':\n' | sed 's/$2y/$2a/'
    # Sau ƒë√≥ uncomment v√† paste hash v√†o gi√° tr·ªã argocdServerAdminPassword b√™n d∆∞·ªõi
    # argocdServerAdminPassword: "$2a$10$..."  # ‚ö†Ô∏è ƒê·ªîI PASSWORD CHO PRODUCTION
    
    # GitHub/GitLab webhook secret (optional)
    # githubSecret: ""
    # gitlabSecret: ""

## ============================================
## ARGO CD SERVER
## ============================================
server:
  # -- Number of replicas for the server
  # üìù BI·∫æN ƒê·ªòNG: C√≥ th·ªÉ gi·∫£m xu·ªëng 1 cho dev environment
  # Hi·ªán t·∫°i: 2 replicas (High Availability)
  # Ph√π h·ª£p v·ªõi: 2-node cluster
  # Gi·∫£m xu·ªëng 1 n·∫øu: Ch·ªâ c√≥ 1 node ho·∫∑c mu·ªën ti·∫øt ki·ªám resources
  replicas: 2  # HA: 2 replicas
  
  # Pod Anti-Affinity: Spread across nodes
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: argocd-server
          topologyKey: kubernetes.io/hostname
  
  # Topology Spread
  topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: kubernetes.io/hostname
    whenUnsatisfiable: ScheduleAnyway
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: argocd-server

  # Server service configuration
  service:
    type: ClusterIP
    annotations: {}

  # Ingress configuration
  ingress:
    enabled: true
    ingressClassName: alb
    
    annotations:
      # ALB Configuration
      alb.ingress.kubernetes.io/scheme: internet-facing
      alb.ingress.kubernetes.io/target-type: ip
      alb.ingress.kubernetes.io/backend-protocol: HTTPS
      
      # SSL/TLS Configuration
      # üìù BI·∫æN ƒê·ªòNG: Certificate ARN cho HTTPS
      # Hi·ªán t·∫°i: Certificate ƒë√£ issued cho argocd.do2506.click
      # Ki·ªÉm tra: aws acm describe-certificate --certificate-arn <ARN> --region ap-southeast-1
      # N·∫øu domain kh√°c: Request certificate m·ªõi v·ªõi ACM
      # Command: aws acm request-certificate --domain-name <DOMAIN> --validation-method DNS --region ap-southeast-1
      alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:ap-southeast-1:372836560690:certificate/202c49bd-24b1-4513-a6dd-0379d106fe9a # ‚ö†Ô∏è THAY ƒê·ªîI
      alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
      alb.ingress.kubernetes.io/ssl-redirect: '443'
      alb.ingress.kubernetes.io/ssl-policy: ELBSecurityPolicy-TLS13-1-2-2021-06
      
      # Health Check
      alb.ingress.kubernetes.io/healthcheck-path: /
      alb.ingress.kubernetes.io/healthcheck-port: traffic-port
      alb.ingress.kubernetes.io/healthcheck-protocol: HTTPS
      alb.ingress.kubernetes.io/healthcheck-interval-seconds: '30'
      alb.ingress.kubernetes.io/healthcheck-timeout-seconds: '5'
      alb.ingress.kubernetes.io/healthy-threshold-count: '2'
      alb.ingress.kubernetes.io/unhealthy-threshold-count: '2'
      
      # Additional Settings
      alb.ingress.kubernetes.io/load-balancer-attributes: idle_timeout.timeout_seconds=300
      alb.ingress.kubernetes.io/tags: Environment=production,Application=argocd,ManagedBy=helm
    
    # üìù BI·∫æN ƒê·ªòNG: Hostname ph·∫£i kh·ªõp v·ªõi domain v√† certificate ARN
    # Hi·ªán t·∫°i: argocd.do2506.click
    # Thay ƒë·ªïi: C·∫£ 2 ch·ªó b√™n d∆∞·ªõi ph·∫£i gi·ªëng nhau
    # Sau khi deploy: T·∫°o Route53 A record pointing to ALB
    hosts:
      - argocd.do2506.click  # ‚ö†Ô∏è THAY ƒê·ªîI
    
    tls:
      - secretName: argocd-tls
        hosts:
          - argocd.do2506.click  # ‚ö†Ô∏è THAY ƒê·ªîI (ph·∫£i kh·ªõp v·ªõi hosts ·ªü tr√™n)

  # Resource limits
  # üìù BI·∫æN ƒê·ªòNG: C√≥ th·ªÉ adjust d·ª±a tr√™n actual usage
  # Hi·ªán t·∫°i: Gi·∫£m xu·ªëng cho 2-node t3.medium cluster
  # Monitor: kubectl top pods -n argocd
  resources:
    limits:
      cpu: 300m
      memory: 384Mi
    requests:
      cpu: 150m     # Reduced from 250m
      memory: 192Mi # Reduced from 256Mi

  # Metrics
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      additionalLabels:
        release: prometheus

  # Service account
  serviceAccount:
    create: true
    name: argocd-server
    automountServiceAccountToken: true

## ============================================
## REPO SERVER
## ============================================
repoServer:
  # -- Number of replicas for the repo server
  # üìù BI·∫æN ƒê·ªòNG: C√≥ th·ªÉ gi·∫£m xu·ªëng 1 cho dev environment
  # Hi·ªán t·∫°i: 2 replicas (High Availability)
  # Repo server x·ª≠ l√Ω Git operations v√† Helm chart rendering
  # Gi·∫£m xu·ªëng 1 n·∫øu: √çt applications ho·∫∑c mu·ªën ti·∫øt ki·ªám resources
  replicas: 2  # HA: 2 replicas
  
  # Pod Anti-Affinity: Spread across nodes
  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: argocd-repo-server
          topologyKey: kubernetes.io/hostname
  
  # Topology Spread
  topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: kubernetes.io/hostname
    whenUnsatisfiable: ScheduleAnyway
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: argocd-repo-server

  # Resource limits (updated for 2-node cluster)
  # üìù BI·∫æN ƒê·ªòNG: C√≥ th·ªÉ gi·∫£m n·∫øu √≠t repositories
  # Hi·ªán t·∫°i: Gi·∫£m xu·ªëng cho 2-node t3.medium cluster
  # Monitor: kubectl top pods -n argocd -l app.kubernetes.io/name=argocd-repo-server
  resources:
    limits:
      cpu: 500m     # Reduced from 1000m
      memory: 512Mi # Reduced from 1Gi
    requests:
      cpu: 250m     # Reduced from 500m
      memory: 256Mi # Reduced from 512Mi

  # Metrics
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      additionalLabels:
        release: prometheus

  # Service account
  serviceAccount:
    create: true
    name: argocd-repo-server
    automountServiceAccountToken: true

## ============================================
## APPLICATION CONTROLLER
## ============================================
controller:
  # -- Number of replicas for the controller
  replicas: 1  # Single replica (stateful, can't scale horizontally)
  
  # Resource limits (updated for 2-node cluster)
  # üìù BI·∫æN ƒê·ªòNG: C√≥ th·ªÉ adjust d·ª±a tr√™n s·ªë l∆∞·ª£ng applications
  # Hi·ªán t·∫°i: 500m CPU / 1Gi memory (ph√π h·ª£p cho < 10 apps)
  # Controller x·ª≠ l√Ω reconciliation v√† health checks
  # GI·∫¢M ƒë·ªÉ ph√π h·ª£p v·ªõi 2-node t3.medium cluster (2 vCPU/node)
  resources:
    limits:
      cpu: 1000m     # Max CPU
      memory: 1536Mi # Max memory
    requests:
      cpu: 500m      # Reduced from 1000m
      memory: 768Mi  # Reduced from 1Gi

  # Metrics
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      additionalLabels:
        release: prometheus

  # Service account
  serviceAccount:
    create: true
    name: argocd-application-controller
    automountServiceAccountToken: true

## ============================================
## DEX (SSO) - Disabled for simplicity
## ============================================
dex:
  enabled: false

## ============================================
## REDIS
## ============================================
redis:
  enabled: true
  
  # Resource limits
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

  # Metrics
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      additionalLabels:
        release: prometheus

## ============================================
## REDIS HA (for production)
## ============================================
# üìù BI·∫æN ƒê·ªòNG: Enable cho production environment
# Hi·ªán t·∫°i: Disabled (single Redis instance)
# Redis HA y√™u c·∫ßu: √çt nh·∫•t 3 nodes cho Sentinel cluster
# Enable khi: Deploy production v·ªõi HA requirements
# Trade-off: TƒÉng complexity v√† resource usage
redis-ha:
  enabled: false  # Set to true for production high availability

## ============================================
## EXTERNAL REDIS (optional)
## ============================================
externalRedis:
  host: ""
  port: 6379
  username: ""
  password: ""

## ============================================
## APPLICATION SET CONTROLLER
## ============================================
applicationSet:
  enabled: true
  replicas: 1
  
  # Resource limits
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

  # Service account
  serviceAccount:
    create: true
    name: argocd-applicationset-controller
    automountServiceAccountToken: true

## ============================================
## NOTIFICATIONS CONTROLLER
## ============================================
# üìù BI·∫æN ƒê·ªòNG: Enable n·∫øu mu·ªën nh·∫≠n notifications
# Hi·ªán t·∫°i: Disabled
# Use case: Slack/Email alerts cho deployment events
# Enable khi: C·∫ßn notify team v·ªÅ sync status, health issues
# Config example: Uncomment ph·∫ßn config b√™n d∆∞·ªõi
notifications:
  enabled: false
  # Enable if you want Slack/Email notifications
  # notifiers:
  #   service.slack: |
  #     token: xoxb-your-slack-token
  # subscriptions:
  #   - recipients:
  #     - slack:deployments-channel
  #     triggers:
  #     - on-deployed
  #     - on-health-degraded

## ============================================
## CRDs
## ============================================
crds:
  install: true
  keep: true
