apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: argocd

resources:
  - ../../base

patches:
  - target:
      kind: Application
      name: metrics-server
    patch: |-
      - op: replace
        path: /metadata/name
        value: metrics-server-staging
      - op: add
        path: /metadata/labels
        value:
          environment: staging
      - op: replace
        path: /spec/source/helm/values
        value: |
          args:
            - --cert-dir=/tmp
            - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
            - --kubelet-use-node-status-port
            - --metric-resolution=15s
          
          # Staging: Medium resources
          resources:
            requests:
              cpu: 100m
              memory: 200Mi
            limits:
              cpu: 200m
              memory: 400Mi
          
          # Staging: 2 replicas for HA
          replicas: 2
          
          podDisruptionBudget:
            maxUnavailable: 1
          
          priorityClassName: system-cluster-critical
