apiVersion: apps/v1
kind: Deployment
metadata:
  name: flowise-server
spec:
  replicas: 3  # Production: 3 replicas for HA
  template:
    spec:
      containers:
      - name: server
        env:
        - name: LOG_LEVEL
          value: "warn"

        - name: DEBUG
          value: "false"

        - name: FLOWISE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: flowise-prod-secrets  # From AWS Secrets Manager
              key: admin-password

        - name: FLOWISE_SECRETKEY_OVERWRITE
          valueFrom:
            secretKeyRef:
              name: flowise-prod-secrets
              key: secret-key

        - name: CORS_ORIGINS
          value: "https://flowise.do2506.click"

        - name: ENVIRONMENT
          valueFrom:
            configMapKeyRef:
              name: flowise-env
              key: ENVIRONMENT

        resources:
          requests:
            cpu: 500m
            memory: 1Gi
          limits:
            cpu: 2000m
            memory: 2Gi

      # Anti-affinity to spread across nodes
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  app: flowise
                  component: server
              topologyKey: kubernetes.io/hostname
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: flowise-ui
spec:
  replicas: 3
  template:
    spec:
      containers:
      - name: ui
        env:
        - name: VITE_PUBLIC_API_URL
          value: "https://flowise.do2506.click/api"

        - name: VITE_ENABLE_ANALYTICS
          value: "true"

        resources:
          requests:
            cpu: 200m
            memory: 512Mi
          limits:
            cpu: 1000m
            memory: 1Gi

      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 100
            podAffinityTerm:
              labelSelector:
                matchLabels:
                  app: flowise
                  component: ui
              topologyKey: kubernetes.io/hostname
