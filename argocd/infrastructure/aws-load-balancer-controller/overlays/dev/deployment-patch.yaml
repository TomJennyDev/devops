apiVersion: apps/v1
kind: Deployment
metadata:
  name: aws-load-balancer-controller
  namespace: kube-system
spec:
  replicas: 2  # HA: 2 replicas across 2 nodes
  template:
    spec:
      # Pod Anti-Affinity: Spread pods across different nodes
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app.kubernetes.io/name
                operator: In
                values:
                - aws-load-balancer-controller
            topologyKey: kubernetes.io/hostname
      
      # Topology Spread: Better distribution
      topologySpreadConstraints:
      - maxSkew: 1
        topologyKey: kubernetes.io/hostname
        whenUnsatisfiable: DoNotSchedule
        labelSelector:
          matchLabels:
            app.kubernetes.io/name: aws-load-balancer-controller
      
      containers:
      - name: controller
        args:
        # ⚠️ UPDATE after 'terraform apply': Get from terraform output cluster_id
        - --cluster-name=my-eks-dev
        - --ingress-class=alb
        # ⚠️ UPDATE if deploying to different region
        - --aws-region=ap-southeast-1
        # ⚠️ UPDATE after 'terraform apply': Get from terraform output vpc_id
        - --aws-vpc-id=vpc-0e6ca42c7851c46c4
        
        # Updated resources for better performance
        resources:
          limits:
            cpu: 500m      # Increased for ALB operations
            memory: 1Gi    # More memory for ingress handling
          requests:
            cpu: 200m      # Increased baseline
            memory: 512Mi  # More memory
        
        # Liveness probe
        livenessProbe:
          httpGet:
            path: /healthz
            port: 61779
            scheme: HTTP
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        
        # Readiness probe
        readinessProbe:
          httpGet:
            path: /readyz
            port: 61779
            scheme: HTTP
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
