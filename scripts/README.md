# Terraform EKS Scripts

Utility scripts for EKS cluster management and ArgoCD deployment.

## Scripts

### 1. `export-cluster-info.sh`
Export Terraform outputs to multiple formats for ArgoCD and other tools.

**Usage:**
```bash
cd terraform-eks/scripts
./export-cluster-info.sh
```

**Output Location:** `environments/dev/cluster-info/`

**Generated Files:**
- `terraform-outputs.json` - Raw Terraform outputs
- `cluster-info.yaml` - Structured cluster information
- `cluster-env.sh` - Environment variables
- `argocd-cluster-values.yaml` - Helm values for ArgoCD
- `cluster-info-configmap.yaml` - Kubernetes ConfigMap
- `README.md` - Quick reference

### 2. `deploy-argocd.sh`
Automated ArgoCD deployment on EKS cluster.

**Prerequisites:**
- Run `export-cluster-info.sh` first
- kubectl configured for EKS cluster
- Helm 3 installed

**Usage:**
```bash
cd terraform-eks/scripts
./deploy-argocd.sh
```

**What it does:**
1. Verify prerequisites (kubectl, helm)
2. Deploy AWS Load Balancer Controller
3. Create ArgoCD namespace
4. Deploy ArgoCD via Helm
5. Retrieve admin password

### 3. `test-environment.sh`
Test EKS cluster health and readiness.

**Usage:**
```bash
cd terraform-eks/scripts
./test-environment.sh
```

### 4. `validate-all.sh`
Validate Terraform configuration before apply.

**Usage:**
```bash
cd terraform-eks/scripts
./validate-all.sh
```

### 5. `install-argocd.sh` (Deprecated)
Legacy ArgoCD installation script. Use `deploy-argocd.sh` instead.

## Typical Workflow

```bash
# 1. Apply Terraform infrastructure
cd terraform-eks/environments/dev
terraform apply

# 2. Export cluster information
cd ../../scripts
./export-cluster-info.sh

# 3. Deploy ArgoCD
./deploy-argocd.sh

# 4. Access ArgoCD
# URL and credentials displayed by deploy script
# Username: admin
# Password: <shown in output>
```

## Directory Structure

```
terraform-eks/
├── scripts/                          # ← You are here
│   ├── export-cluster-info.sh       # Export Terraform outputs
│   ├── deploy-argocd.sh            # Deploy ArgoCD
│   ├── test-environment.sh         # Test cluster
│   ├── validate-all.sh             # Validate Terraform
│   └── README.md                   # This file
└── environments/
    └── dev/
        ├── cluster-info/            # Generated by export-cluster-info.sh
        │   ├── terraform-outputs.json
        │   ├── cluster-info.yaml
        │   ├── cluster-env.sh
        │   └── ...
        ├── main.tf
        └── terraform.tfvars
```

## Environment Variables

Load cluster information into your shell:

```bash
source ../environments/dev/cluster-info/cluster-env.sh

# Available variables:
echo $EKS_CLUSTER_NAME
echo $EKS_REGION
echo $AWS_ACCOUNT_ID
echo $VPC_ID
echo $ECR_FLOWISE_SERVER
```

## Troubleshooting

### Script not found
```bash
# Make sure you're in the scripts directory
cd terraform-eks/scripts
```

### Permission denied
```bash
# Make scripts executable
chmod +x *.sh
```

### Cluster info not found
```bash
# Run export first
./export-cluster-info.sh

# Then deploy ArgoCD
./deploy-argocd.sh
```

### Cannot access cluster
```bash
# Configure kubectl
aws eks update-kubeconfig --region ap-southeast-1 --name my-eks-dev

# Verify
kubectl get nodes
```

## See Also

- [DEPLOY-ARGOCD-GUIDE.md](../environments/dev/DEPLOY-ARGOCD-GUIDE.md) - Detailed ArgoCD deployment guide
- [COREDNS-SLOW-CREATION-FIX.md](../../docs/COREDNS-SLOW-CREATION-FIX.md) - CoreDNS troubleshooting
- [ECR-SETUP-GUIDE.md](../../docs/ECR-SETUP-GUIDE.md) - ECR repository setup
